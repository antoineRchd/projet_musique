FROM python:3.11-slim

# Installer les dÃ©pendances systÃ¨me
RUN apt-get update && apt-get install -y \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# CrÃ©er le rÃ©pertoire de travail
WORKDIR /app

# Copier les fichiers de requirements
COPY requirements.txt .

# Installer les dÃ©pendances Python
RUN pip install --no-cache-dir -r requirements.txt

# Copier le code du consumer
COPY consumer/ ./consumer/

# CrÃ©er les rÃ©pertoires de sortie
RUN mkdir -p /app/output

# CrÃ©er un script d'initialisation pour le consumer
RUN echo '#!/bin/bash\n\
    echo "ðŸŽ§ Attente de Kafka et du Producer..."\n\
    while ! nc -z kafka 9093; do\n\
    echo "Kafka pas encore prÃªt, attente..."\n\
    sleep 5\n\
    done\n\
    echo "âœ… Kafka est prÃªt !"\n\
    sleep 20\n\
    echo "ðŸš€ DÃ©marrage du Consumer Kafka..."\n\
    cd consumer\n\
    python consumer.py\n\
    ' > /app/start_consumer.sh

RUN chmod +x /app/start_consumer.sh

CMD ["/app/start_consumer.sh"] 