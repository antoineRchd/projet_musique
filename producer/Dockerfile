FROM python:3.11-slim

# Installer les dÃ©pendances systÃ¨me
RUN apt-get update && apt-get install -y \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# CrÃ©er le rÃ©pertoire de travail
WORKDIR /app

# Copier les fichiers de requirements
COPY requirements.txt .

# Installer les dÃ©pendances Python
RUN pip install --no-cache-dir -r requirements.txt

# Copier le code du producteur
COPY producer/ ./producer/

# Script d'initialisation : attente de Kafka puis publication
RUN echo '#!/bin/bash\n\
    echo "ðŸŽµ Attente de Kafka..."\n\
    while ! nc -z kafka 9093; do\n\
    echo "Kafka pas encore prÃªt, attente..."\n\
    sleep 5\n\
    done\n\
    echo "âœ… Kafka est prÃªt !"\n\
    sleep 10\n\
    echo "ðŸš€ Chargement des donnÃ©es Spotify..."\n\
    cd producer\n\
    python producer.py\n\
    echo "âœ… DonnÃ©es chargÃ©es avec succÃ¨s !"\n' > /app/load_spotify_data.sh

RUN chmod +x /app/load_spotify_data.sh

CMD ["/app/load_spotify_data.sh"] 